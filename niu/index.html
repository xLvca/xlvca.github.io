<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NIU P100 BLE Interface</title>
  <style>
    body { background:#121212;color:#e0e0e0;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:start;height:100vh;padding:1rem }
    button { background:#1f1f1f;border:1px solid #444;color:#fff;padding:10px 20px;border-radius:5px;margin:5px;cursor:pointer }
    button:hover { background:#333 }
    pre { background:#1e1e1e;padding:1rem;border-radius:5px;max-width:90vw;overflow-x:auto }
    .controls { display:flex;flex-wrap:wrap;justify-content:center;gap:10px }
  </style>
</head>
<body>
<h1>NIU P100 Scooter BLE Interface</h1>
<div class="controls">
  <button onclick="connectToScooter()">ğŸ”Œ Connect</button>
  <button onclick="sendAuthSequence()">ğŸ” Authenticate</button>
  <button onclick="readBatteryStatus()">ğŸ”‹ Battery</button>
  <button onclick="readVersionInfo()">ğŸ§¬ Version</button>
  <button onclick="readLockStatus()">ğŸ”’ Lock Status</button>
  <button onclick="lockScooter()">ğŸ” Lock</button>
  <button onclick="unlockScooter()">ğŸ”“ Unlock</button>
  <button onclick="readGPSStatus()">ğŸ§­ GPS</button>
  <button onclick="startDump()">ğŸ“¦ Dump</button>
  <button onclick="readOdometer()">ğŸ› Odometer</button>
  <button onclick="readRideMode()">âš™ï¸ Ride Mode</button>
  <button onclick="readMCUStatus()">ğŸ§ª MCU</button>
  <button onclick="getControllerSN()">ğŸ”¢ SN</button>
  <button onclick="readMotorTemp()">ğŸŒ¡ï¸ Motor Temp</button>
  <button onclick="readVoltage()">ğŸ”Œ Voltage</button>
  <button onclick="readFirmwareVersion()">ğŸ“„ FW Ver</button>
  <button onclick="enterOTAMode()">ğŸ§  Enter OTA</button>
  <button onclick="triggerFlash()">âš ï¸ Flash</button>
  <button onclick="readBLEMac()">ğŸ“¡ BLE MAC</button>
  <button onclick="readVehicleStatus()">ğŸš¦ Vehicle</button>
  <button onclick="readAllSensors()">ğŸ“Š All Sensors</button>
  <button onclick="readDiagReport()">ğŸ§¾ Diagnostics</button>
  <button onclick="readWheelSpeed()">ğŸŒ€ Wheel Speed</button>
  <button onclick="readThrottlePosition()">ğŸšï¸ Throttle</button>
  <button onclick="readBrakeStatus()">ğŸ›‘ Brake</button>
  <button onclick="readLightingStatus()">ğŸ’¡ Lights</button>
  <button onclick="readChargeCycles()">ğŸ”„ Charge Cycles</button>
  <button onclick="readBMSHealth()">ğŸ©º BMS</button>
</div>
<pre id="log">Log:</pre>
<script>
  let device, server, service, characteristic, notifyChar, bleSecrets = null;

  const SERVICE_UUID = '0000fee7-0000-1000-8000-00805f9b34fb',
        CHAR_WRITE_UUID = '000036f5-0000-1000-8000-00805f9b34fb',
        CHAR_NOTIFY_UUID = '000036f6-0000-1000-8000-00805f9b34fb';

  function log(m) {
    const e = document.getElementById("log");
    e.textContent += `\n> ${m}`;
    e.scrollTop = e.scrollHeight;
  }

  async function promptSecrets() {
    const input = prompt('ğŸ” FÃ¼ge dein BLE Secrets JSON ein:');
    try {
      bleSecrets = JSON.parse(input);
      const keys = ["bleName", "blePassword", "bleSign", "bleAes", "bleMac"];
      if (!keys.every(k => k in bleSecrets)) throw new Error("Missing required key");
      log("âœ… BLE Secrets geladen");
    } catch (e) {
      alert("âŒ UngÃ¼ltiges JSON: " + e.message);
      log("âŒ Fehler beim Parsen der Secrets");
      throw e;
    }
  }

  async function connectToScooter() {
    try {
      if (!bleSecrets) return log("â— Keine Secrets geladen.");
      log('ğŸ” Suche nach Scooter: ' + bleSecrets.bleName);
      device = await navigator.bluetooth.requestDevice({
        filters: [{ name: bleSecrets.bleName }],
        optionalServices: [SERVICE_UUID]
      });
      log('ğŸ“¶ Verbinde...');
      server = await device.gatt.connect();
      service = await server.getPrimaryService(SERVICE_UUID);
      characteristic = await service.getCharacteristic(CHAR_WRITE_UUID);
      notifyChar = await service.getCharacteristic(CHAR_NOTIFY_UUID);
      await notifyChar.startNotifications();
      notifyChar.addEventListener("characteristicvaluechanged", handleNotifications);
      log("âœ… Verbunden & Listening");
    } catch (e) {
      log("âŒ Verbindung fehlgeschlagen: " + e);
    }
  }

  function handleNotifications(e) {
    const v = e.target.value;
    const hex = Array.from(new Uint8Array(v.buffer)).map(b => b.toString(16).padStart(2, '0')).join(' ');
    log("ğŸ”” Notification: " + hex);
  }

  async function aesEncryptCBC128(keyText, dataText) {
    const key = new TextEncoder().encode(keyText.padEnd(16));
    const data = new TextEncoder().encode(dataText);
    const cryptoKey = await crypto.subtle.importKey('raw', key, { name: 'AES-CBC' }, false, ['encrypt']);
    const iv = new Uint8Array(16);
    const encrypted = await crypto.subtle.encrypt({ name: 'AES-CBC', iv }, cryptoKey, data);
    return new Uint8Array(encrypted);
  }

  async function sendAuthSequence() {
    if (!characteristic || !bleSecrets) return log('â— Not connected or secrets missing');
    try {
      const encrypted = await aesEncryptCBC128(bleSecrets.bleAes, "auth_challenge");
      await characteristic.writeValue(encrypted);
      log("âœ… Auth Token gesendet");
    } catch (e) {
      log("âŒ Auth Fehler: " + e.message);
    }
  }

  async function writeCommand(c) {
    if (!characteristic) return log('â— Nicht verbunden');
    await characteristic.writeValue(c);
  }

  const Commands = {
    readBatteryStatus:    [0x02, 0x00, 0xB1],
    readVersionInfo:      [0x02, 0x00, 0xA4],
    readLockStatus:       [0x02, 0x00, 0xA2],
    lockScooter:          [0x05, 0x00, 0xA1, 0x01, 0x01],
    unlockScooter:        [0x05, 0x00, 0xA1, 0x01, 0x00],
    readGPSStatus:        [0x02, 0x00, 0xB3],
    startDump:            [0x02, 0x00, 0xE1],
    readOdometer:         [0x02, 0x00, 0xB6],
    readRideMode:         [0x02, 0x00, 0xB5],
    readMCUStatus:        [0x02, 0x00, 0xB4],
    getControllerSN:      [0x02, 0x00, 0xA6],
    readMotorTemp:        [0x02, 0x00, 0xB2],
    readVoltage:          [0x02, 0x00, 0xB7],
    readFirmwareVersion:  [0x02, 0x00, 0xA5],
    enterOTAMode:         [0x03, 0x00, 0xD1],
    triggerFlash:         [0x03, 0x00, 0xD5],
    readBLEMac:           [0x02, 0x00, 0xA9],
    readVehicleStatus:    [0x02, 0x00, 0xB8],
    readAllSensors:       [0x02, 0x00, 0xBC],
    readDiagReport:       [0x02, 0x00, 0xBD],
    readWheelSpeed:       [0x02, 0x00, 0xC0],
    readThrottlePosition: [0x02, 0x00, 0xC1],
    readBrakeStatus:      [0x02, 0x00, 0xC2],
    readLightingStatus:   [0x02, 0x00, 0xC3],
    readChargeCycles:     [0x02, 0x00, 0xC4],
    readBMSHealth:        [0x02, 0x00, 0xC5],
  };

  for (const [fn, cmd] of Object.entries(Commands)) {
    window[fn] = async () => {
      await writeCommand(new Uint8Array(cmd));
      log(`ğŸ“¨ ${fn} gesendet`);
    };
  }

  window.addEventListener("load", async () => {
    try {
      await promptSecrets();
    } catch (e) {
      log("âš ï¸ Secrets benÃ¶tigt, App nicht bereit.");
    }
  });

  window.addEventListener("beforeunload", () => {
    if (device?.gatt?.connected) {
      device.gatt.disconnect();
      log("ğŸ”Œ Disconnected");
    }
  });
</script>
</body>
</html>
