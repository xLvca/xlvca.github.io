<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NIU P100 BLE Interface</title>
  <style>
    body {
      background: #121212;
      color: #e0e0e0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      height: 100vh;
      padding: 1rem;
    }
    button {
      background: #1f1f1f;
      border: 1px solid #444;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #333;
    }
    pre {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 5px;
      max-width: 90vw;
      overflow-x: auto;
      max-height: 30vh;
      overflow-y: auto;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <h1>NIU P100 Scooter BLE Interface</h1>
  <div class="controls">
    <button onclick="connectToScooter()">ğŸ”Œ Connect</button>
    <button onclick="scanAllServices()">ğŸ” Scan Services</button>
    <button onclick="fullDebugBLE()">ğŸ§© Full BLE Debug</button>
    <button onclick="sendAuthSequence()">ğŸ” Authenticate</button>
    <button onclick="readBatteryStatus()">ğŸ”‹ Battery</button>
    <button onclick="readVersionInfo()">ğŸ§¬ Version</button>
    <button onclick="readLockStatus()">ğŸ”’ Lock Status</button>
    <button onclick="lockScooter()">ğŸ” Lock</button>
    <button onclick="unlockScooter()">ğŸ”“ Unlock</button>
    <button onclick="readGPSStatus()">ğŸ§­ GPS</button>
    <button onclick="startDump()">ğŸ“¦ Dump</button>
    <button onclick="readOdometer()">ğŸ› Odometer</button>
    <button onclick="readRideMode()">âš™ï¸ Ride Mode</button>
    <button onclick="readMCUStatus()">ğŸ§ª MCU</button>
    <button onclick="getControllerSN()">ğŸ”¢ SN</button>
    <button onclick="readMotorTemp()">ğŸŒ¡ï¸ Motor Temp</button>
    <button onclick="readVoltage()">ğŸ”Œ Voltage</button>
    <button onclick="readFirmwareVersion()">ğŸ“„ FW Ver</button>
    <button onclick="enterOTAMode()">ğŸ§  Enter OTA</button>
    <button onclick="triggerFlash()">âš ï¸ Flash</button>
    <button onclick="readBLEMac()">ğŸ“¡ BLE MAC</button>
    <button onclick="readVehicleStatus()">ğŸš¦ Vehicle</button>
    <button onclick="readAllSensors()">ğŸ“Š All Sensors</button>
    <button onclick="readDiagReport()">ğŸ§¾ Diagnostics</button>
    <button onclick="readWheelSpeed()">ğŸŒ€ Wheel Speed</button>
    <button onclick="readThrottlePosition()">ğŸšï¸ Throttle</button>
    <button onclick="readBrakeStatus()">ğŸ›‘ Brake</button>
    <button onclick="readLightingStatus()">ğŸ’¡ Lights</button>
    <button onclick="readChargeCycles()">ğŸ”„ Charge Cycles</button>
    <button onclick="readBMSHealth()">ğŸ©º BMS</button>
  </div>
  <pre id="log">Log:</pre>
  <script>
    let device, server, service, characteristic, notifyChar;
    const SERVICE_UUID = '0000fee7-0000-1000-8000-00805f9b34fb';
    const CHAR_WRITE_UUID = '000036f5-0000-1000-8000-00805f9b34fb';
    const CHAR_NOTIFY_UUID = '000036f6-0000-1000-8000-00805f9b34fb';

    function log(m) {
      const e = document.getElementById('log');
      e.textContent += `\n> ${m}`;
      e.scrollTop = e.scrollHeight;
    }

    async function connectToScooter() {
      try {
        log('Requesting Bluetooth device...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'NIU' }],
          optionalServices: [SERVICE_UUID]
        });
        log('Connecting...');
        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHAR_WRITE_UUID);
        notifyChar = await service.getCharacteristic(CHAR_NOTIFY_UUID);
        await notifyChar.startNotifications();
        notifyChar.addEventListener('characteristicvaluechanged', handleNotifications);
        log('Connected and listening for notifications.');
      } catch (e) {
        log('Error: ' + e);
      }
    }

    async function scanAllServices() {
      try {
        log('Requesting device (no filters)...');
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: []
        });
        log('Connecting...');
        server = await device.gatt.connect();
        const services = await server.getPrimaryServices();
        log(`Found ${services.length} services:`);
        for (const s of services) {
          log(`- ${s.uuid}`);
          const chars = await s.getCharacteristics();
          for (const c of chars) {
            log(`  â†³ Characteristic: ${c.uuid}`);
          }
        }
      } catch (e) {
        log('Scan error: ' + e);
      }
    }

    async function fullDebugBLE() {
      try {
        log('ğŸ” Starting full BLE debug scan...');
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: []
        });
        log(`ğŸŸ¢ Selected: ${device.name || '(unnamed device)'}`);
        server = await device.gatt.connect();
        const services = await server.getPrimaryServices();

        log(`ğŸ“¡ Found ${services.length} services:\n`);
        for (const s of services) {
          log(`ğŸ“˜ Service: ${s.uuid}`);
          try {
            const characteristics = await s.getCharacteristics();
            for (const c of characteristics) {
              let props = Object.entries(c.properties)
                .filter(([_, v]) => v)
                .map(([k]) => k).join(', ');
              log(`â€ƒâ€ƒğŸ”¹ Characteristic: ${c.uuid} [${props}]`);
            }
          } catch (e) {
            log(`â€ƒâ€ƒâš ï¸ Error reading characteristics: ${e}`);
          }
        }

        log(`âœ… BLE scan done. Use real UUIDs above to connect.`);

      } catch (e) {
        log(`âŒ Debug BLE Error: ${e}`);
      }
    }

    function handleNotifications(e) {
      const v = e.target.value;
      const h = Array.from(new Uint8Array(v.buffer)).map(b => b.toString(16).padStart(2, '0')).join(' ');
      log(`Notification: ${h}`);
    }

    async function aesEncrypt(k, d) {
      const key = await crypto.subtle.importKey('raw', k, { name: 'AES-CBC' }, false, ['encrypt']);
      const iv = new Uint8Array(16);
      const enc = await crypto.subtle.encrypt({ name: 'AES-CBC', iv: iv }, key, d);
      return new Uint8Array(enc);
    }

    async function sendAuthSequence() {
      if (!characteristic) return log('Not connected.');
      const k = new Uint8Array([0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x30,0x41,0x42,0x43,0x44,0x45,0x46]);
      const d = new TextEncoder().encode('auth_challenge');
      const e = await aesEncrypt(k, d);
      await characteristic.writeValue(e);
      log('Encrypted auth token sent.');
    }

    async function writeCommand(c) {
      if (!characteristic) return log('Not connected.');
      await characteristic.writeValue(c);
    }

    async function readBatteryStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xB1])); log('Battery status requested.'); }
    async function readVersionInfo() { await writeCommand(new Uint8Array([0x02,0x00,0xA4])); log('Version info requested.'); }
    async function readLockStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xA2])); log('Lock status requested.'); }
    async function lockScooter() { await writeCommand(new Uint8Array([0x05,0x00,0xA1,0x01,0x01])); log('Lock command sent.'); }
    async function unlockScooter() { await writeCommand(new Uint8Array([0x05,0x00,0xA1,0x01,0x00])); log('Unlock command sent.'); }
    async function readGPSStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xB3])); log('GPS status requested.'); }
    async function readOdometer() { await writeCommand(new Uint8Array([0x02,0x00,0xB6])); log('Odometer requested.'); }
    async function readRideMode() { await writeCommand(new Uint8Array([0x02,0x00,0xB5])); log('Ride mode requested.'); }
    async function startDump() { await writeCommand(new Uint8Array([0x02,0x00,0xE1])); log('Firmware dump triggered.'); }
    async function readMCUStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xB4])); log('MCU status requested.'); }
    async function getControllerSN() { await writeCommand(new Uint8Array([0x02,0x00,0xA6])); log('Controller Serial requested.'); }
    async function readMotorTemp() { await writeCommand(new Uint8Array([0x02,0x00,0xB2])); log('Motor temperature requested.'); }
    async function readVoltage() { await writeCommand(new Uint8Array([0x02,0x00,0xB7])); log('Voltage requested.'); }
    async function readFirmwareVersion() { await writeCommand(new Uint8Array([0x02,0x00,0xA5])); log('Firmware version requested.'); }
    async function enterOTAMode() { await writeCommand(new Uint8Array([0x03,0x00,0xD1])); log('OTA mode command sent.'); }
    async function triggerFlash() { await writeCommand(new Uint8Array([0x03,0x00,0xD5])); log('Flash trigger sent (dangerous).'); }
    async function readBLEMac() { await writeCommand(new Uint8Array([0x02,0x00,0xA9])); log('BLE MAC requested.'); }
    async function readVehicleStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xB8])); log('Vehicle status requested.'); }
    async function readAllSensors() { await writeCommand(new Uint8Array([0x02,0x00,0xBC])); log('All sensors requested.'); }
    async function readDiagReport() { await writeCommand(new Uint8Array([0x02,0x00,0xBD])); log('Diagnostics report requested.'); }
    async function readWheelSpeed() { await writeCommand(new Uint8Array([0x02,0x00,0xC0])); log('Wheel speed requested.'); }
    async function readThrottlePosition() { await writeCommand(new Uint8Array([0x02,0x00,0xC1])); log('Throttle position requested.'); }
    async function readBrakeStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xC2])); log('Brake status requested.'); }
    async function readLightingStatus() { await writeCommand(new Uint8Array([0x02,0x00,0xC3])); log('Lighting status requested.'); }
    async function readChargeCycles() { await writeCommand(new Uint8Array([0x02,0x00,0xC4])); log('Charge cycles requested.'); }
    async function readBMSHealth() { await writeCommand(new Uint8Array([0x02,0x00,0xC5])); log('BMS health requested.'); }

    window.addEventListener('beforeunload', () => {
      if (device?.gatt?.connected) {
        device.gatt.disconnect();
        log('Disconnected from device.');
      }
    });
  </script>
</body>
</html>
