<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIU BLE UUID Auto Connect</title>
  <style>
    body { background: #121212; color: #e0e0e0; font-family: sans-serif; padding: 1rem; }
    textarea, button { width: 100%; background: #1e1e1e; color: #fff; border: 1px solid #555; border-radius: 5px; padding: 10px; margin-top: 10px; }
    button:hover { background: #333; }
    #log { white-space: pre-wrap; background: #1e1e1e; padding: 1rem; border-radius: 5px; margin-top: 1rem; max-height: 50vh; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>🔧 NIU BLE Auto Connect</h1>

  <label for="secrets">🔑 BLE Secrets JSON:</label>
  <textarea id="secrets" rows="3" placeholder='{"bleName":"NIU KQi",...}'></textarea>
  <button onclick="loadSecrets()">✅ Load Secrets</button>
  <button onclick="connect()">🔌 Connect to Scooter</button>

  <div id="log">Log:</div>

  <script>
    let bleSecrets = {}, device, server, fee7Service, writeChar, notifyChar;

    const CHAR_WRITE_UUID = '000036f5-0000-1000-8000-00805f9b34fb';
    const CHAR_NOTIFY_UUID = '000036f6-0000-1000-8000-00805f9b34fb';

    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += `\n${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function loadSecrets() {
      try {
        const raw = document.getElementById('secrets').value;
        bleSecrets = JSON.parse(raw);
        if (!bleSecrets.bleName) throw new Error("Missing bleName.");
        log("✅ BLE Secrets geladen");
      } catch (e) {
        log("❌ Fehler beim Laden der Secrets: " + e.message);
      }
    }

    async function connect() {
      if (!bleSecrets.bleName) return log("❌ Keine Secrets geladen.");
      try {
        log("🔎 Suche nach Scooter: " + bleSecrets.bleName);
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: bleSecrets.bleName }],
          optionalServices: ['battery_service', 'device_information'] // keine spezifische UUID erzwingen
        });

        log("📶 Verbinde...");
        server = await device.gatt.connect();

        const allServices = await server.getPrimaryServices();
        log(`🔍 ${allServices.length} Services gefunden:`);

        for (const s of allServices) {
          log(`- Service: ${s.uuid}`);
          if (s.uuid.startsWith('0000fee7') || s.uuid === '0000fee7-0000-1000-8000-00805f9b34fb') {
            fee7Service = s;
          }
        }

        if (!fee7Service) {
          log("❌ fee7-Service nicht gefunden.");
          return;
        }

        log("✅ fee7-Service gefunden: " + fee7Service.uuid);
        const chars = await fee7Service.getCharacteristics();

        for (const c of chars) {
          if (c.uuid === CHAR_WRITE_UUID) writeChar = c;
          if (c.uuid === CHAR_NOTIFY_UUID) {
            notifyChar = c;
            await notifyChar.startNotifications();
            notifyChar.addEventListener('characteristicvaluechanged', handleNotify);
          }
        }

        if (!writeChar || !notifyChar) {
          log("❌ Wichtige Characteristics nicht gefunden.");
          return;
        }

        log("✅ Verbunden & Characteristics bereit.");
      } catch (e) {
        log("❌ Verbindung fehlgeschlagen: " + e.message);
      }
    }

    function handleNotify(event) {
      const value = event.target.value;
      const hex = Array.from(new Uint8Array(value.buffer))
        .map(b => b.toString(16).padStart(2, '0')).join(' ');
      log("📨 Notification: " + hex);
    }
  </script>
</body>
</html>
