<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scooter BLE Web Utility</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #f3f3f3; color: #333; }
    button, select { padding: 0.5em 1em; margin: 0.5em; }
    #output { margin-top: 1em; white-space: pre-wrap; background: #fff; padding: 1em; border-radius: 0.5em; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>Scooter BLE Web Utility</h1>
  <button onclick="connectScooter()">ğŸ”— Connect</button>
  <button onclick="sendF3()">ğŸ“Š Request Data (F3)</button>
  <select id="regionSelect">
    <option value="0x01">ğŸ‡ªğŸ‡º EU</option>
    <option value="0x02">ğŸ‡ºğŸ‡¸ US</option>
    <option value="0x03">ğŸ‡·ğŸ‡º RU</option>
  </select>
  <button onclick="changeRegion()">ğŸŒ Set Region</button>

  <div id="output">Status: Not connected.</div>

  <script>
    let device, server, service, writeChar, notifyChar;
    const output = msg => document.getElementById('output').textContent += `\n${msg}`;

    async function connectScooter() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
        });
        output(`Device selected: ${device.name}`);

        server = await device.gatt.connect();
        output("Connected to GATT server. Press the power button on your scooter if needed.");

        service = await server.getPrimaryService("0000ffe0-0000-1000-8000-00805f9b34fb");
        writeChar = await service.getCharacteristic("0000ffe1-0000-1000-8000-00805f9b34fb");
        notifyChar = writeChar;

        await notifyChar.startNotifications();
        notifyChar.addEventListener("characteristicvaluechanged", handleNotifications);
        output("Notifications enabled.");

        await new Promise(r => setTimeout(r, 1000)); // kurze Pause
        await sendAuth();
      } catch (error) {
        output("Error: " + error);
      }
    }

    function hex(bytes) {
      return Array.from(bytes, b => b.toString(16).padStart(2, '0')).join(' ');
    }

    function handleNotifications(event) {
      const value = event.target.value;
      const bytes = new Uint8Array(value.buffer);
      output(`Received: ${hex(bytes)}`);
    }

    async function sendF3() {
      if (!writeChar) return output("Not connected");
      const f3 = Uint8Array.from([0xF3, 0x00]);
      await writeChar.writeValue(f3);
      output("Sent F3 packet");
    }

    async function changeRegion() {
      if (!writeChar) return output("Not connected");
      const regionCode = document.getElementById('regionSelect').value;
      const regionByte = parseInt(regionCode);
      const cmd = Uint8Array.from([0xF0, 0x05, 0x20, 0x03, regionByte, 0x00, 0x00]);
      await writeChar.writeValue(cmd);
      output(`Region change sent: ${hex(cmd)}`);
    }

    async function sendAuth() {
      if (!writeChar) return output("Not connected");
      const authCmd = Uint8Array.from([0xF0, 0x0A, 0x21, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]);
      await writeChar.writeValue(authCmd);
      output("Auth command sent. Press the power button on your scooter if required.");
    }
  </script>
</body>
</html>
