<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIU P100 BLE Web</title>
  <style>
    body {
      background: #121212;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 1rem;
    }
    textarea, button {
      width: 100%;
      background: #1e1e1e;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
    }
    button:hover {
      background: #333;
    }
    #log {
      white-space: pre-wrap;
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 5px;
      margin-top: 1rem;
      max-height: 50vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ðŸ”§ NIU BLE Web Interface</h1>

  <label for="secrets">ðŸ”‘ BLE Secrets JSON:</label>
  <textarea id="secrets" rows="3" placeholder='{"bleName":"NIU KQi",...}'></textarea>
  <button onclick="loadSecrets()">âœ… Load Secrets</button>
  <button onclick="connect()">ðŸ”Œ Connect to Scooter</button>

  <div id="log">Log:</div>

  <script>
    let bleSecrets = {}, device, server, service, writeChar, notifyChar;

    const SERVICE_UUID = '0000fee7-0000-1000-8000-00805f9b34fb';
    const CHAR_WRITE_UUID = '000036f5-0000-1000-8000-00805f9b34fb';
    const CHAR_NOTIFY_UUID = '000036f6-0000-1000-8000-00805f9b34fb';

    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += `\n${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function loadSecrets() {
      try {
        const raw = document.getElementById('secrets').value;
        bleSecrets = JSON.parse(raw);
        if (!bleSecrets.bleName || !bleSecrets.blePassword || !bleSecrets.bleSign || !bleSecrets.bleAes || !bleSecrets.bleMac) {
          throw new Error("Missing fields.");
        }
        log("âœ… BLE Secrets geladen");
      } catch (e) {
        log("âŒ Fehler beim Laden der Secrets: " + e.message);
      }
    }

    async function connect() {
      if (!bleSecrets.bleName) return log("âŒ Keine Secrets geladen.");
      try {
        log("ðŸ”Ž Suche nach Scooter: " + bleSecrets.bleName);
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: bleSecrets.bleName }],
          optionalServices: [
            SERVICE_UUID,
            CHAR_WRITE_UUID,
            CHAR_NOTIFY_UUID,
            '0000180f-0000-1000-8000-00805f9b34fb', // Battery
            '0000180a-0000-1000-8000-00805f9b34fb'  // Device Info
          ]
        });

        log("ðŸ“¶ Verbinde...");
        server = await device.gatt.connect();
        service = await server.getPrimaryService(SERVICE_UUID);
        writeChar = await service.getCharacteristic(CHAR_WRITE_UUID);
        notifyChar = await service.getCharacteristic(CHAR_NOTIFY_UUID);

        await notifyChar.startNotifications();
        notifyChar.addEventListener('characteristicvaluechanged', handleNotify);
        log("âœ… Verbunden & lausche auf Benachrichtigungen.");
      } catch (e) {
        log("âŒ Verbindung fehlgeschlagen: " + e.message);
      }
    }

    function handleNotify(event) {
      const value = event.target.value;
      const hex = Array.from(new Uint8Array(value.buffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join(' ');
      log("ðŸ“¨ Notification: " + hex);
    }
  </script>
</body>
</html>
