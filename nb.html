<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scooter BLE Utility</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 2em; background: #121212; color: #fff; }
    h1 { font-size: 1.8em; color: #00f59f; }
    button, select {
      padding: 0.6em 1.2em;
      margin: 0.5em;
      background-color: #222;
      color: #00f59f;
      border: 1px solid #00f59f;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #00f59f; color: #000; }
    #output {
      margin-top: 1em;
      white-space: pre-wrap;
      background: #1e1e1e;
      padding: 1em;
      border-radius: 0.5em;
      box-shadow: 0 0 10px rgba(0,255,150,0.1);
      font-family: monospace;
    }
    .section { margin-bottom: 2em; }
  </style>
</head>
<body>
  <h1>ğŸ›´ Scooter BLE Web Utility</h1>

  <div class="section">
    <button onclick="connectScooter()">ğŸ”— Connect</button>
    <button onclick="sendF3()">ğŸ“Š Request F3 Data</button>
    <button onclick="lockScooter()">ğŸ”’ Lock</button>
    <button onclick="unlockScooter()">ğŸ”“ Unlock</button>
    <button onclick="toggleLight()">ğŸ’¡ Toggle Light</button>
  </div>

  <div class="section">
    <label for="regionSelect">ğŸŒ Set Region:</label>
    <select id="regionSelect">
      <option value="0x01">ğŸ‡ªğŸ‡º EU</option>
      <option value="0x02">ğŸ‡ºğŸ‡¸ US</option>
      <option value="0x03">ğŸ‡·ğŸ‡º RU</option>
    </select>
    <button onclick="changeRegion()">Change</button>
  </div>

  <div id="output">Status: Not connected.</div>

  <script>
    let device, server, service, writeChar, notifyChar;
    const output = msg => document.getElementById('output').textContent += `\n${msg}`;

    async function connectScooter() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
        });
        output(`Device selected: ${device.name}`);

        server = await device.gatt.connect();
        output("Connected to GATT server. Press the power button if needed.");

        service = await server.getPrimaryService("0000ffe0-0000-1000-8000-00805f9b34fb");
        writeChar = await service.getCharacteristic("0000ffe1-0000-1000-8000-00805f9b34fb");
        notifyChar = writeChar;

        await notifyChar.startNotifications();
        notifyChar.addEventListener("characteristicvaluechanged", handleNotifications);
        output("Notifications enabled.");

        await new Promise(r => setTimeout(r, 1000));
        await sendAuth();
      } catch (error) {
        output("Error: " + error);
      }
    }

    function hex(bytes) {
      return Array.from(bytes, b => b.toString(16).padStart(2, '0')).join(' ');
    }

    function handleNotifications(event) {
      const value = event.target.value;
      const bytes = new Uint8Array(value.buffer);
      output(`Received: ${hex(bytes)}`);
    }

    async function sendF3() {
      if (!writeChar) return output("Not connected");
      const f3 = Uint8Array.from([0xF3, 0x00]);
      await writeChar.writeValue(f3);
      output("Sent F3 packet");
    }

    async function sendAuth() {
      if (!writeChar) return output("Not connected");
      const authCmd = Uint8Array.from([0xF0, 0x0A, 0x21, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]);
      await writeChar.writeValue(authCmd);
      output("Auth command sent. Press the power button if required.");
    }

    async function changeRegion() {
      if (!writeChar) return output("Not connected");
      const regionCode = document.getElementById('regionSelect').value;
      const regionByte = parseInt(regionCode);
      const cmd = Uint8Array.from([0xF0, 0x05, 0x20, 0x03, regionByte, 0x00, 0x00]);
      await writeChar.writeValue(cmd);
      output(`Region change sent: ${hex(cmd)}`);
    }

    async function lockScooter() {
      if (!writeChar) return output("Not connected");
      const lockCmd = Uint8Array.from([0xF0, 0x01, 0x24, 0x01]);
      await writeChar.writeValue(lockCmd);
      output("Sent lock command");
    }

    async function unlockScooter() {
      if (!writeChar) return output("Not connected");
      const unlockCmd = Uint8Array.from([0xF0, 0x01, 0x24, 0x00]);
      await writeChar.writeValue(unlockCmd);
      output("Sent unlock command");
    }

    async function toggleLight() {
      if (!writeChar) return output("Not connected");
      const toggleCmd = Uint8Array.from([0xF0, 0x01, 0x11, 0x01]);
      await writeChar.writeValue(toggleCmd);
      output("Toggled light");
    }
  </script>
</body>
</html>
