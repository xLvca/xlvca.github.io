<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Aufenthaltstitel Scan & OCR</title>
<style>
  /* Dunkles modernes Theme */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  :root {
    --bg: #121212;
    --fg: #e0e0e0;
    --primary: #0af;
    --secondary: #08c;
    --accent: #0ff;
    --danger: #f55;
    --shadow: rgba(0,0,0,0.9);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0; padding: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  header {
    padding: 1rem 1.2rem;
    text-align: center;
    font-weight: 600;
    font-size: 1.4rem;
    letter-spacing: 0.04em;
    border-bottom: 1px solid #222;
    user-select: none;
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
    padding: 0 1rem 1rem;
    width: 100%;
  }

  #video-container {
    position: relative;
    border-radius: 14px;
    overflow: hidden;
    margin: 1rem 0 0.8rem;
    background: #000;
    box-shadow: 0 0 20px var(--primary);
  }

  video {
    width: 100%;
    height: auto;
    object-fit: cover;
    aspect-ratio: 4/3;
    filter: brightness(0.9);
    user-select: none;
  }

  #scan-frame {
    position: absolute;
    top: 10%;
    left: 10%;
    width: 80%;
    height: 60%;
    border: 3px solid var(--accent);
    border-radius: 8px;
    pointer-events: none;
    box-shadow:
      0 0 8px var(--accent),
      inset 0 0 10px var(--accent);
    animation: pulse 3s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow:
        0 0 8px var(--accent),
        inset 0 0 10px var(--accent);
    }
    50% {
      box-shadow:
        0 0 20px var(--accent),
        inset 0 0 20px var(--accent);
    }
  }

  #controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
  }

  button, select {
    background: var(--secondary);
    color: var(--fg);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
    box-shadow: 0 2px 5px var(--shadow);
  }

  button:hover, select:hover {
    background: var(--primary);
  }

  button:active {
    transform: scale(0.96);
  }

  #flash-btn {
    background: #222;
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    position: relative;
  }

  #flash-btn svg {
    fill: var(--accent);
    width: 24px;
    height: 24px;
  }

  #flash-btn.flash-on svg {
    filter: drop-shadow(0 0 3px var(--accent));
  }

  #status {
    min-height: 2.4rem;
    font-size: 1rem;
    font-weight: 500;
    color: var(--accent);
    margin-bottom: 0.4rem;
    white-space: pre-line;
  }

  #result {
    flex-grow: 1;
    background: #222;
    padding: 1rem;
    border-radius: 10px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9rem;
    white-space: pre-wrap;
    overflow-y: auto;
    box-shadow: inset 0 0 10px #000;
  }

  select {
    font-size: 1rem;
  }

  @media (max-width: 480px) {
    body {
      font-size: 14px;
    }
    #video-container {
      margin-top: 0.5rem;
    }
  }
</style>
</head>
<body>

<header>Aufenthaltstitel Scan & OCR</header>

<main>
  <div id="video-container">
    <video id="video" autoplay playsinline muted></video>
    <div id="scan-frame" aria-hidden="true"></div>
  </div>

  <div id="controls" role="group" aria-label="Bedienelemente">
    <select id="document-select" aria-label="Dokumenttyp auswählen">
      <option value="aufenthaltstitel-front">Aufenthaltstitel - Vorderseite</option>
      <option value="aufenthaltstitel-back">Aufenthaltstitel - Rückseite</option>
      <option value="ausweis-front">Personalausweis - Vorderseite</option>
      <option value="ausweis-back">Personalausweis - Rückseite</option>
    </select>

    <button id="scan-btn" aria-label="Scan starten">Scan starten</button>
    <button id="flash-btn" aria-pressed="false" aria-label="Taschenlampe ein/aus" title="Taschenlampe ein/aus">
      <svg viewBox="0 0 24 24"><path d="M6 2h12l-3 7h-6L6 2zM9 9h6v11H9V9z"/></svg>
    </button>
  </div>

  <div id="status" role="status" aria-live="polite">Bereit zum Scannen</div>
  <pre id="result" aria-live="polite" aria-atomic="true"></pre>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
(async () => {
  const video = document.getElementById('video');
  const scanFrame = document.getElementById('scan-frame');
  const scanBtn = document.getElementById('scan-btn');
  const flashBtn = document.getElementById('flash-btn');
  const statusDiv = document.getElementById('status');
  const resultDiv = document.getElementById('result');
  const documentSelect = document.getElementById('document-select');

  let stream;
  let track;
  let torchOn = false;
  let currentDocSide = documentSelect.value;

  async function startCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 960 }
        },
        audio: false
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      // Prüfe ob Torch unterstützt wird
      const imageCapture = new ImageCapture(track);
      const capabilities = await imageCapture.getPhotoCapabilities();
      if (capabilities.fillLightMode.includes('torch')) {
        flashBtn.disabled = false;
      } else {
        flashBtn.disabled = true;
      }
    } catch (e) {
      statusDiv.textContent = 'Kamera konnte nicht gestartet werden: ' + e.message;
      flashBtn.disabled = true;
    }
  }

  function toggleFlash() {
    if (!track) return;
    const constraints = { advanced: [{ torch: !torchOn }] };
    track.applyConstraints(constraints).then(() => {
      torchOn = !torchOn;
      flashBtn.setAttribute('aria-pressed', torchOn);
      flashBtn.classList.toggle('flash-on', torchOn);
      // Blitz sehr dezent machen -> hier keine extra Helligkeit, nur An/Aus
    }).catch(() => {
      statusDiv.textContent = 'Torch konnte nicht umgeschaltet werden.';
    });
  }

  function cropCanvasFromVideo(videoEl, cropRect) {
    // cropRect = {x, y, width, height} relative 0..1 Werte vom Video Element
    const canvas = document.createElement('canvas');
    canvas.width = cropRect.width * videoEl.videoWidth;
    canvas.height = cropRect.height * videoEl.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(
      videoEl,
      cropRect.x * videoEl.videoWidth,
      cropRect.y * videoEl.videoHeight,
      canvas.width,
      canvas.height,
      0, 0, canvas.width, canvas.height
    );
    return canvas;
  }

  // OCR Parsers für Aufenthaltstitel Vorderseite
  function parseAufenthaltstitelFront(text) {
    text = text.toUpperCase();
    const data = {};

    // Dokumentnummer (typisch 8-12 alphanumerisch) evtl. nach "DOKUMENTNUMMER" oder "DOK.NR"
    let docNr = null;
    let docNrRegex = /(DOKUMENTNUMMER|DOK\.NR|DOCUMENT NUMBER|DOC NR|NR)[\s:]*([A-Z0-9]{8,12})/i;
    let m = text.match(docNrRegex);
    if (m && m[2]) docNr = m[2];

    // Wenn nicht gefunden: versuche die erste 8-12 Zeichen alphanumerisch oben rechts zu finden
    if (!docNr) {
      let lines = text.split('\n').slice(0, 10).join('\n');
      let fallback = lines.match(/[A-Z0-9]{8,12}/i);
      if (fallback) docNr = fallback[0];
    }
    if (docNr) data.Dokumentnummer = docNr;

    // Geburtsdatum nach "GEBURTSDATUM" oder "DATE OF BIRTH" und folgendem Datum
    let dob = null;
    let dobRegex = /(GEBURTSDATUM|DATE OF BIRTH)[\s:\-]*([0-3]?\d)[\.\-\/]?([01]?\d)[\.\-\/]?(\d{4})/i;
    let dobMatch = text.match(dobRegex);
    if (!dobMatch) {
      // Versuch in nächster Zeile
      let lines = text.split('\n');
      for (let i=0; i < lines.length; i++) {
        if (lines[i].includes('GEBURTSDATUM') || lines[i].includes('DATE OF BIRTH')) {
          let nextLine = lines[i+1] || '';
          let dateMatch = nextLine.match(/([0-3]?\d)[\.\-\/]?([01]?\d)[\.\-\/]?(\d{4})/);
          if (dateMatch) {
            dobMatch = [null, null, dateMatch[1], dateMatch[2], dateMatch[3]];
            break;
          }
        }
      }
    }
    if (dobMatch) {
      let day = dobMatch[2].padStart(2,'0');
      let month = dobMatch[3].padStart(2,'0');
      let year = dobMatch[4];
      dob = `${day}.${month}.${year}`;
      data.Geburtsdatum = dob;
    }

    return data;
  }

  // OCR Parsers für Aufenthaltstitel Rückseite (MRZ und Adresse)
  function parseAufenthaltstitelBack(text) {
    text = text.toUpperCase();
    const data = {};

    // MRZ Linien mit mind. 2 '<'
    const mrzLines = text.split('\n').filter(l => (l.match(/</g) || []).length >= 2);
    if (mrzLines.length > 0) {
      data.MRZ = mrzLines.join('\n');
    }

    // Adresse mit PLZ und Ort
    const addrMatch = text.match(/(\d{5})\s+([A-ZÄÖÜß\s\-]+)/);
    if (addrMatch) data.Adresse = addrMatch[0].trim();

    return data;
  }

  // Parsers für Personalausweis vorne und hinten können hier ähnlich ergänzt werden

  // Formatierung der Ausgabe
  function formatData(data) {
    if (!data || Object.keys(data).length === 0) return "Keine relevanten Daten erkannt.\nBitte nochmal versuchen und ruhig halten.";
    let out = '';
    for (const [k,v] of Object.entries(data)) {
      out += `${k}: ${v}\n`;
    }
    return out.trim();
  }

  async function doScan() {
    if (!video.videoWidth) {
      statusDiv.textContent = 'Video nicht verfügbar, bitte warten...';
      return;
    }

    statusDiv.textContent = 'Scanne... Bitte ruhig halten!';
    resultDiv.textContent = '';

    // Crop Rechteck genau passend zum scanFrame in Verhältnis zum Video (so wie der Rahmen)
    const rect = scanFrame.getBoundingClientRect();
    const videoRect = video.getBoundingClientRect();
    const cropRect = {
      x: (rect.left - videoRect.left) / videoRect.width,
      y: (rect.top - videoRect.top) / videoRect.height,
      width: rect.width / videoRect.width,
      height: rect.height / videoRect.height
    };

    const canvas = cropCanvasFromVideo(video, cropRect);
    // Für OCR besser kontrast verstärken:
    const ctx = canvas.getContext('2d');
    let imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
    for(let i=0; i < imgData.data.length; i +=4){
      // Simple Kontrastverstärkung (linear)
      for(let c=0;c<3;c++){
        imgData.data[i+c] = Math.min(255, Math.max(0, 1.2*(imgData.data[i+c]-128)+128));
      }
    }
    ctx.putImageData(imgData, 0, 0);

    // OCR mit Tesseract
    try {
      const { data: { text } } = await Tesseract.recognize(canvas, 'deu', { logger: m => {
        // Optional: Status update z.B. m.status === 'recognizing text' && statusDiv.textContent = 'Erkennung läuft...';
      }});

      let extractedData = {};

      switch(currentDocSide) {
        case 'aufenthaltstitel-front':
          extractedData = parseAufenthaltstitelFront(text);
          break;
        case 'aufenthaltstitel-back':
          extractedData = parseAufenthaltstitelBack(text);
          break;
        case 'ausweis-front':
        case 'ausweis-back':
          // Placeholder: noch nicht implementiert
          extractedData = { Info: 'Support für Ausweis bald verfügbar' };
          break;
      }

      resultDiv.textContent = formatData(extractedData);
      statusDiv.textContent = extractedData && Object.keys(extractedData).length > 0 ? 'Scan erfolgreich!' : 'Keine Daten erkannt. Bitte nochmal versuchen.';
    } catch (e) {
      statusDiv.textContent = 'Fehler bei OCR: ' + e.message;
    }
  }

  scanBtn.addEventListener('click', () => {
    doScan();
  });

  flashBtn.addEventListener('click', () => {
    toggleFlash();
  });

  documentSelect.addEventListener('change', e => {
    currentDocSide = e.target.value;
    resultDiv.textContent = '';
    statusDiv.textContent = 'Dokumenttyp geändert. Bereit zum Scannen.';
  });

  await startCamera();

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
  });
})();
</script>

</body>
</html>
