<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Dokumenten Scanner (Aufenthaltstitel & Ausweis)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; background: #0a0f12; color: #00ffd0; font-family: 'Roboto Mono', monospace;
    display: flex; flex-direction: column; height: 100vh; align-items: center; justify-content: flex-start;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    user-select:none;
  }
  header {
    padding: 1.2rem; font-size: 1.5rem; font-weight: 700; color: #00ffe0;
    text-align: center; width: 100%;
    background: linear-gradient(90deg, #008080 0%, #00fff0 100%);
    box-shadow: 0 3px 10px #00ffcc88;
  }
  main {
    flex-grow: 1; width: 100%; max-width: 480px; padding: 1rem 1rem 1.5rem 1rem;
    display: flex; flex-direction: column; align-items: center;
  }
  #video-container {
    position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 14px;
    overflow: hidden; box-shadow: 0 0 25px #00ffccaa;
    background: #111;
  }
  video {
    width: 100%; height: 100%; object-fit: cover;
    filter: brightness(1.05) contrast(1.1);
    will-change: transform;
  }
  #scan-frame {
    position: absolute;
    border: 3px solid #00ffd0;
    border-radius: 16px;
    top: 20%;
    left: 7.5%;
    width: 85%;
    height: 45%;
    box-shadow: 0 0 20px #00ffccaa;
    pointer-events: none;
    animation: pulse 2.4s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 20px #00ffccee; }
    50% { box-shadow: 0 0 32px #00fffee0; }
  }
  #controls {
    margin-top: 18px;
    width: 100%; max-width: 480px;
    display: flex; flex-wrap: wrap; justify-content: space-between; gap: 12px;
  }
  select, button {
    font-size: 1.1rem; border-radius: 10px; border: none;
    padding: 12px 18px;
    background: #003030cc;
    color: #00ffcc;
    font-weight: 700;
    user-select:none;
    cursor: pointer;
    flex-grow: 1;
    transition: background-color 0.25s ease;
    box-shadow: 0 0 12px #00808088;
  }
  select:focus, button:focus {
    outline: none;
    background: #005050cc;
    box-shadow: 0 0 15px #00ffd0ff;
  }
  select:hover, button:hover {
    background: #005050cc;
    box-shadow: 0 0 20px #00ffe0ff;
  }
  #flash-btn {
    max-width: 110px;
    background: #003330dd;
  }
  #flash-btn.active {
    background: #00ffccdd;
    color: #002222;
  }
  #status {
    margin-top: 14px;
    font-size: 1.1rem;
    color: #00ffcc;
    min-height: 1.4em;
    text-align: center;
    user-select:none;
  }
  #result {
    margin-top: 22px;
    background: #001919dd;
    padding: 15px 18px;
    border-radius: 14px;
    width: 100%;
    max-width: 480px;
    min-height: 8rem;
    font-size: 1.05rem;
    white-space: pre-wrap;
    color: #00ffcc;
    font-weight: 600;
    overflow-wrap: break-word;
    box-shadow: inset 0 0 25px #008080cc;
  }
  @media (max-width: 480px) {
    body {
      padding: 0 10px 10px 10px;
    }
    select, button {
      font-size: 1rem;
      padding: 10px 14px;
      flex-grow: unset;
      flex-basis: 48%;
    }
    #flash-btn {
      flex-basis: 100%;
      max-width: none;
    }
    #result {
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
<header>Dokumenten Scanner (Aufenthaltstitel & Ausweis)</header>

<main>
  <div id="video-container" aria-label="Kamera Vorschau">
    <video id="video" autoplay playsinline muted></video>
    <div id="scan-frame" aria-hidden="true"></div>
  </div>

  <div id="controls">
    <select id="doc-type" aria-label="Dokument auswählen">
      <option value="aufenthaltstitel">Aufenthaltstitel</option>
      <option value="ausweis">Personalausweis</option>
    </select>
    <select id="doc-side" aria-label="Dokumentseite auswählen">
      <option value="front">Vorderseite</option>
      <option value="back">Rückseite</option>
    </select>
    <button id="scan-btn" aria-label="Scan starten">Scannen</button>
    <button id="flash-btn" aria-label="Blitzlicht an/aus">Blitz</button>
  </div>

  <div id="status" role="status" aria-live="polite" aria-atomic="true">Bereit zum Scannen</div>
  <pre id="result" aria-label="Scan Ergebnis"></pre>
</main>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="cv['onRuntimeInitialized']=()=>{console.log('OpenCV.js geladen');}"></script>
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
(() => {
  const video = document.getElementById('video');
  const scanFrame = document.getElementById('scan-frame');
  const scanBtn = document.getElementById('scan-btn');
  const flashBtn = document.getElementById('flash-btn');
  const docTypeSelect = document.getElementById('doc-type');
  const docSideSelect = document.getElementById('doc-side');
  const statusDiv = document.getElementById('status');
  const resultDiv = document.getElementById('result');

  let stream = null;
  let track = null;
  let flashOn = false;

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 },
          torch: false,
          focusMode: "continuous"
        }
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      statusDiv.textContent = 'Kamera bereit, wähle Dokument und Seite.';
    } catch (e) {
      statusDiv.textContent = 'Kamera konnte nicht gestartet werden: ' + e.message;
    }
  }

  function toggleFlash() {
    if (!track) return;
    const capabilities = track.getCapabilities();
    if (!capabilities.torch) {
      statusDiv.textContent = 'Blitzlicht nicht verfügbar auf diesem Gerät.';
      return;
    }
    flashOn = !flashOn;
    track.applyConstraints({ advanced: [{ torch: flashOn }] });
    flashBtn.classList.toggle('active', flashOn);
    statusDiv.textContent = flashOn ? 'Blitz aktiviert' : 'Blitz deaktiviert';
  }
  flashBtn.addEventListener('click', toggleFlash);

  // Berechnet das Crop Rechteck des Scanrahmens relativ zum Video
  function getCropRect() {
    const videoRect = video.getBoundingClientRect();
    const frameRect = scanFrame.getBoundingClientRect();
    return {
      x: (frameRect.left - videoRect.left) / videoRect.width,
      y: (frameRect.top - videoRect.top) / videoRect.height,
      width: frameRect.width / videoRect.width,
      height: frameRect.height / videoRect.height
    };
  }

  function cropCanvasFromVideo(video, crop) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth * crop.width;
    canvas.height = video.videoHeight * crop.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(
      video,
      video.videoWidth * crop.x,
      video.videoHeight * crop.y,
      canvas.width,
      canvas.height,
      0,
      0,
      canvas.width,
      canvas.height
    );
    return canvas;
  }

  // Bildvorverarbeitung mit OpenCV.js (Graustufen, Kontrast, Schärfen, adaptive Binarisierung)
  function preprocessImage(canvas) {
    try {
      let src = cv.imread(canvas);
      cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);

      // Histogramm gleichrichten (Kontrast)
      let dst = new cv.Mat();
      cv.equalizeHist(src, dst);

      // Schärfen (Kernel)
      let kernel = cv.Mat.ones(3, 3, cv.CV_32F);
      kernel.data32F.set([0, -1, 0, -1, 5, -1, 0, -1, 0]);
      cv.filter2D(dst, dst, cv.CV_8U, kernel);

      // Adaptive Binarisierung
      cv.adaptiveThreshold(dst, dst, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv.THRESH_BINARY, 15, 5);

      cv.imshow(canvas, dst);

      src.delete(); dst.delete(); kernel.delete();
    } catch (e) {
      console.warn("OpenCV preprocessing failed:", e);
    }
    return canvas;
  }

  // Mehrfach-OCR mit leicht unterschiedlichen Einstellungen
  async function doOCR(canvas) {
    statusDiv.textContent = 'OCR läuft... Bitte Geduld.';
    const worker = Tesseract.createWorker({
      logger: m => {
        if (m.status === 'recognizing text') {
          statusDiv.textContent = `OCR: ${Math.round(m.progress * 100)}%`;
        }
      }
    });
    await worker.load();
    await worker.loadLanguage('deu');
    await worker.initialize('deu');

    // 1. Normaler Lauf
    let { data: { text } } = await worker.recognize(canvas);

    // 2. Lauf mit Invertierung (Versuch, bei schlechtem Scan)
    const ctx = canvas.getContext('2d');
    ctx.globalCompositeOperation = 'difference';
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    let { data: { text: invText } } = await worker.recognize(canvas);

    await worker.terminate();

    // Besseren Text zurückgeben
    return text.length >= invText.length ? text : invText;
  }

  // Daten aus OCR Text extrahieren (DOB, Ablaufdatum, Nummer, MRZ)
  function extractData(text, docType, docSide) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
    let dob = null, expiry = null, docNum = null, mrz = null;

    // Suche nach Datum (tt.mm.jjjj oder tt-mm-jjjj)
    const dateRegex = /\b(\d{2}[.\-\/]\d{2}[.\-\/]\d{4})\b/g;
    const matches = text.match(dateRegex) || [];

    // Beispiel: Einfach das erste Datum als DOB und das letzte als Ablaufdatum
    if (matches.length >= 1) dob = matches[0];
    if (matches.length >= 2) expiry = matches[matches.length - 1];

    // Suche nach Nummern (z.B. 9-12stellige alphanumerisch)
    const numRegex = /\b([A-Z0-9]{6,15})\b/g;
    const nums = text.match(numRegex) || [];
    if (nums.length) docNum = nums[0];

    // MRZ suchen (2 oder 3 Zeilen, aus denen OCR sehr viele <, > etc sieht)
    const mrzLines = lines.filter(line => /^[A-Z0-9<]{10,}$/.test(line));
    if (mrzLines.length >= 2) mrz = mrzLines.slice(0,3).join('\n');

    return { dob, expiry, docNum, mrz };
  }

  async function scanDocument() {
    if (!video.videoWidth || !video.videoHeight) {
      statusDiv.textContent = 'Video noch nicht bereit.';
      return;
    }
    statusDiv.textContent = 'Scanne... bitte halte das Dokument ruhig.';
    scanBtn.disabled = true;
    flashBtn.disabled = true;

    try {
      const crop = getCropRect();
      let canvas = cropCanvasFromVideo(video, crop);
      canvas = preprocessImage(canvas);
      const ocrText = await doOCR(canvas);
      const data = extractData(ocrText, docTypeSelect.value, docSideSelect.value);

      let displayText = `Dokument: ${docTypeSelect.options[docTypeSelect.selectedIndex].text}\nSeite: ${docSideSelect.options[docSideSelect.selectedIndex].text}\n\n`;
      displayText += `OCR Rohtext:\n${ocrText.trim()}\n\n`;
      displayText += `Extrahierte Daten:\n`;
      displayText += `Geburtsdatum: ${data.dob || '-'}\n`;
      displayText += `Ablaufdatum: ${data.expiry || '-'}\n`;
      displayText += `Dokumentnummer: ${data.docNum || '-'}\n`;
      displayText += `MRZ:\n${data.mrz || '-'}\n`;

      resultDiv.textContent = displayText;
      statusDiv.textContent = 'Scan fertig. Prüfe das Ergebnis.';
    } catch (e) {
      statusDiv.textContent = 'Fehler beim Scannen: ' + e.message;
      console.error(e);
    }
    scanBtn.disabled = false;
    flashBtn.disabled = false;
  }

  scanBtn.addEventListener('click', scanDocument);

  // Seite & Dokumentenwechsel - Update Scanrahmen (optional)
  function updateScanFrame() {
    // Unterschiedliche Scanrahmen je Dokument und Seite
    if (docTypeSelect.value === 'aufenthaltstitel') {
      if (docSideSelect.value === 'front') {
        scanFrame.style.top = '20%'; scanFrame.style.left = '7.5%';
        scanFrame.style.width = '85%'; scanFrame.style.height = '45%';
      } else {
        scanFrame.style.top = '25%'; scanFrame.style.left = '10%';
        scanFrame.style.width = '80%'; scanFrame.style.height = '50%';
      }
    } else { // ausweis
      if (docSideSelect.value === 'front') {
        scanFrame.style.top = '18%'; scanFrame.style.left = '10%';
        scanFrame.style.width = '80%'; scanFrame.style.height = '50%';
      } else {
        scanFrame.style.top = '22%'; scanFrame.style.left = '8%';
        scanFrame.style.width = '83%'; scanFrame.style.height = '47%';
      }
    }
  }
  docTypeSelect.addEventListener('change', updateScanFrame);
  docSideSelect.addEventListener('change', updateScanFrame);
  updateScanFrame();

  startCamera();

})();
</script>

</body>
</html>
