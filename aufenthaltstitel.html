<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>DE Ausweis & Aufenthaltstitel Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif;
    background: #121212;
    color: #e0e0e0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    padding: 15px 20px;
    background: #1f1f1f;
    font-weight: 600;
    font-size: 1.25rem;
    text-align: center;
    letter-spacing: 0.03em;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px 15px;
  }
  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 10px;
  }
  select, button {
    font-size: 1rem;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    background: #2a2a2a;
    color: #e0e0e0;
    cursor: pointer;
    min-width: 140px;
    transition: background 0.3s ease;
  }
  select:focus, button:focus {
    outline: none;
    background: #3d3d3d;
  }
  button:active {
    background: #4a90e2;
  }

  #videoContainer {
    position: relative;
    flex: 1;
    max-height: 60vh;
    background: #000;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 0 12px rgba(0,0,0,0.8);
    margin-bottom: 10px;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #scanFrame {
    position: absolute;
    border: 3px solid #4a90e2;
    border-radius: 12px;
    pointer-events: none;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  #flashBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #4a90e2cc;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s ease;
    z-index: 15;
  }
  #flashBtn.active {
    background: #fff;
    color: #4a90e2;
  }

  #status {
    min-height: 26px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 6px;
    color: #82c91e;
  }
  #result {
    flex: 1;
    background: #1f1f1f;
    padding: 12px 14px;
    border-radius: 10px;
    font-family: monospace;
    white-space: pre-wrap;
    overflow-y: auto;
    user-select: text;
  }

  @media (max-width: 420px) {
    select, button {
      min-width: 100%;
    }
    .controls {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<header>Deutscher Ausweis & Aufenthaltstitel Scanner</header>
<main>
  <div class="controls">
    <select id="docType">
      <option value="aufenthaltstitel" selected>Aufenthaltstitel</option>
      <option value="ausweis">Personalausweis</option>
    </select>
    <select id="docSide">
      <option value="front" selected>Vorderseite</option>
      <option value="back">Rückseite</option>
    </select>
    <button id="scanBtn">Scannen</button>
  </div>
  <div id="videoContainer">
    <video autoplay playsinline muted id="video"></video>
    <div id="scanFrame"></div>
    <button id="flashBtn" title="Blitz an/aus">⚡</button>
  </div>
  <div id="status"></div>
  <pre id="result" aria-live="polite"></pre>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script>
(async () => {
  const video = document.getElementById('video');
  const scanFrame = document.getElementById('scanFrame');
  const scanBtn = document.getElementById('scanBtn');
  const statusDiv = document.getElementById('status');
  const resultDiv = document.getElementById('result');
  const docTypeSelect = document.getElementById('docType');
  const docSideSelect = document.getElementById('docSide');
  const flashBtn = document.getElementById('flashBtn');

  let stream = null;
  let track = null;
  let flashOn = false;

  // Start Kamera mit Rückseiten-Kamera falls möglich
  async function startCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
    }
    statusDiv.textContent = 'Kamera startet...';

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];

      // Prüfe ob Blitz verfügbar
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        flashBtn.style.display = 'flex';
      } else {
        flashBtn.style.display = 'none';
      }

      statusDiv.textContent = 'Kamera bereit.';
    } catch (e) {
      statusDiv.textContent = 'Kamerazugriff verweigert oder nicht verfügbar.';
    }
  }

  // Blitz an/aus
  async function toggleFlash() {
    if (!track) return;
    flashOn = !flashOn;
    try {
      await track.applyConstraints({ advanced: [{ torch: flashOn }] });
      flashBtn.classList.toggle('active', flashOn);
    } catch {
      statusDiv.textContent = 'Blitz konnte nicht geschaltet werden.';
    }
  }
  flashBtn.addEventListener('click', toggleFlash);

  // Scanrahmen Position & Größe dynamisch
  function updateScanFrame() {
    const docType = docTypeSelect.value;
    const docSide = docSideSelect.value;
    // Setze Positionen pro Typ & Seite (relativ zum videoContainer)
    if (docType === 'aufenthaltstitel') {
      if (docSide === 'front') {
        scanFrame.style.top = '18%';
        scanFrame.style.left = '7%';
        scanFrame.style.width = '86%';
        scanFrame.style.height = '45%';
      } else {
        scanFrame.style.top = '35%';
        scanFrame.style.left = '7%';
        scanFrame.style.width = '86%';
        scanFrame.style.height = '46%';
      }
    } else {
      // Ausweis
      if (docSide === 'front') {
        scanFrame.style.top = '17%';
        scanFrame.style.left = '8%';
        scanFrame.style.width = '84%';
        scanFrame.style.height = '48%';
      } else {
        scanFrame.style.top = '34%';
        scanFrame.style.left = '8%';
        scanFrame.style.width = '84%';
        scanFrame.style.height = '48%';
      }
    }
  }
  docTypeSelect.addEventListener('change', () => { updateScanFrame(); clearResult(); });
  docSideSelect.addEventListener('change', () => { updateScanFrame(); clearResult(); });

  function clearResult() {
    statusDiv.textContent = '';
    resultDiv.textContent = '';
  }

  // Crop Bereich im VideoContainer relativ zum ScanFrame
  function getCropRect() {
    const videoRect = video.getBoundingClientRect();
    const containerRect = video.parentElement.getBoundingClientRect();
    const frameRect = scanFrame.getBoundingClientRect();

    // Berechne Crop innerhalb des Videos
    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;

    const x = (frameRect.left - videoRect.left) * scaleX;
    const y = (frameRect.top - videoRect.top) * scaleY;
    const width = frameRect.width * scaleX;
    const height = frameRect.height * scaleY;

    return { x, y, width, height };
  }

  // OCR & Parsing mit Kontrast-Boost & MRZ-Check
  async function scanImage() {
    if (!track) return;
    statusDiv.textContent = 'Scan läuft...';
    clearResult();

    // Canvas erzeugen, Bereich aus Video zeichnen
    const crop = getCropRect();
    const canvas = document.createElement('canvas');
    canvas.width = crop.width;
    canvas.height = crop.height;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, crop.x, crop.y, crop.width, crop.height, 0, 0, canvas.width, canvas.height);

    // Kontrast erhöhen (leicht)
    let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < imgData.data.length; i += 4) {
      for (let c = 0; c < 3; c++) {
        let val = imgData.data[i + c];
        val = ((val - 128) * 1.3) + 128;
        imgData.data[i + c] = Math.min(255, Math.max(0, val));
      }
    }
    ctx.putImageData(imgData, 0, 0);

    statusDiv.textContent = 'Texterkennung läuft...';

    try {
      const { data: { text } } = await Tesseract.recognize(canvas, 'deu', {
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ÄÖÜß.,-/:<> ',
        logger: m => {
          if (m.status === 'recognizing text') {
            statusDiv.textContent = `Texterkennung: ${(m.progress * 100).toFixed(0)}%`;
          }
        }
      });

      statusDiv.textContent = 'Text erkannt, Daten werden ausgewertet...';
      const parsed = parseDocumentText(text, docTypeSelect.value, docSideSelect.value);
      displayResult(parsed, text);
    } catch (err) {
      statusDiv.textContent = 'Fehler bei der Texterkennung: ' + err.message;
    }
  }

  // MRZ-Prüfzifferberechnung (Mod 10)
  function checkMRZChecksum(mrzStr) {
    const charValues = c => {
      if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;
      if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55;
      if (c === '<') return 0;
      return 0;
    };
    const weights = [7, 3, 1];
    let sum = 0;
    for (let i = 0; i < mrzStr.length - 1; i++) {
      const val = charValues(mrzStr[i]);
      const w = weights[i % 3];
      sum += val * w;
    }
    const checkDigit = parseInt(mrzStr[mrzStr.length - 1], 10);
    return sum % 10 === checkDigit;
  }

  // Parsing Funktion: Erkennung & Datenextraktion mit MRZ Validierung
  function parseDocumentText(text, docType, docSide) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const parsed = {};

    // MRZ Erkennung Rückseite
    if (docSide === 'back') {
      // MRZ Linien suchen: 2 Zeilen mit mind 25 Zeichen aus A-Z 0-9 <
      const mrzLines = lines.filter(l => /^[A-Z0-9<]{25,}$/.test(l));
      if (mrzLines.length >= 2) {
        parsed['MRZ1'] = mrzLines[0];
        parsed['MRZ2'] = mrzLines[1];

        // Ablaufdatum (Position 13-18 MRZ2, 6 Zeichen YYMMDD) + Prüfziffer an Pos 19
        const expiryRaw = mrzLines[1].substring(13, 19);
        const expiryCheck = mrzLines[1][19];
        const expiryValid = checkMRZChecksum(expiryRaw + expiryCheck);

        // Geburtsdatum (Pos 7-12 MRZ2) + Prüfziffer (Pos 13)
        const dobRaw = mrzLines[1].substring(7, 13);
        const dobCheck = mrzLines[1][13];
        const dobValid = checkMRZChecksum(dobRaw + dobCheck);

        // Dokumentnummer (Pos 0-9 MRZ1) + Prüfziffer (Pos 9)
        const docNumRaw = mrzLines[0].substring(0, 9);
        const docNumCheck = mrzLines[0][9];
        const docNumValid = checkMRZChecksum(docNumRaw + docNumCheck);

        parsed['Dokumentnummer'] = docNumRaw + (docNumValid ? ' ✅' : ' ❌');
        parsed['Geburtsdatum'] = dobRaw + (dobValid ? ' ✅' : ' ❌');
        parsed['Ablaufdatum'] = expiryRaw + (expiryValid ? ' ✅' : ' ❌');

        // Staatsangehörigkeit MRZ1 Pos 10-12
        parsed['Staatsangehörigkeit'] = mrzLines[0].substring(10, 13);

        // Gültigkeitscheck Ablaufdatum
        try {
          // YYMMDD → Datum umwandeln (Jahr ab 2000)
          const y = 2000 + parseInt(expiryRaw.substring(0, 2));
          const m = parseInt(expiryRaw.substring(2, 4)) - 1;
          const d = parseInt(expiryRaw.substring(4, 6));
          const expiryDate = new Date(y, m, d);
          const today = new Date();
          const diffMonths = (expiryDate.getFullYear() - today.getFullYear()) * 12 + (expiryDate.getMonth() - today.getMonth());

          parsed['Gültig bis'] = expiryDate.toLocaleDateString('de-DE');
          if (diffMonths < 0) parsed['Status Ablaufdatum'] = 'Abgelaufen';
          else if (diffMonths < 7) parsed['Status Ablaufdatum'] = 'Bald abgelaufen';
          else parsed['Status Ablaufdatum'] = 'Gültig';
        } catch { }
      } else {
        parsed['Fehler'] = 'Keine MRZ-Zeilen gefunden oder zu kurz';
      }
    } else {
      // Vorderseite Parsing: Grobe Suche nach DOB, Dokumentnummer, Gültigkeit

      for (const line of lines) {
        // DOB (z.B. "Geburtsdatum 12.04.1990")
        let dobMatch = line.match(/Geburtsdatum\s*[:\-]?\s*(\d{2}[.\-/]\d{2}[.\-/]\d{4})/i);
        if (dobMatch) {
          parsed['Geburtsdatum'] = dobMatch[1];
        }
        // Dokumentnummer (oft oben rechts: 10-15 Zeichen alphanumerisch)
        let docNumMatch = line.match(/(Dokumentnummer|Ausweis-Nr\.?|Nr\.?)\s*[:\-]?\s*([A-Z0-9]{8,15})/i);
        if (docNumMatch) {
          parsed['Dokumentnummer'] = docNumMatch[2];
        }
        // Ablaufdatum / Gültig bis
        let expMatch = line.match(/(Gültig bis|gültig bis|Expir\w*|Expires?)\s*[:\-]?\s*(\d{2}[.\-/]\d{2}[.\-/]\d{4})/i);
        if (expMatch) {
          parsed['Gültig bis'] = expMatch[2];
        }
      }

      // Wenn kein expliziter Dokumentnummer gefunden, versuche evtl. erste Zeile mit Muster auszugeben
      if (!parsed['Dokumentnummer'] && lines.length > 0) {
        let maybeDocNum = lines.find(l => /^[A-Z0-9]{8,15}$/.test(l));
        if (maybeDocNum) parsed['Dokumentnummer'] = maybeDocNum;
      }
    }

    return parsed;
  }

  // Ergebnisse anzeigen
  function displayResult(parsed, rawText) {
    let output = '';
    if (parsed['Fehler']) {
      statusDiv.textContent = parsed['Fehler'];
      return;
    }
    for (const [key, val] of Object.entries(parsed)) {
      output += `${key}: ${val}\n`;
    }
    output += '\n--- RAW OCR TEXT ---\n' + rawText.trim();

    resultDiv.textContent = output;
    statusDiv.textContent = 'Scan fertig.';
  }

  updateScanFrame();
  await startCamera();

  scanBtn.addEventListener('click', scanImage);
})();
</script>
</body>
</html>
