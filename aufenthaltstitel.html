<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>DE Ausweis & Aufenthaltstitel Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    background: #121212;
    color: #ddd;
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
  }
  header {
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    font-size: 1.4rem;
    border-bottom: 1px solid #222;
    background: #181818;
  }
  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem 1rem 2rem;
    gap: 1rem;
  }
  #video-container {
    position: relative;
    width: 100vw;
    max-width: 440px;
    aspect-ratio: 4 / 3;
    border-radius: 16px;
    overflow: hidden;
    background: #222;
    box-shadow: 0 0 12px rgba(10, 170, 255, 0.15);
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.95);
  }
  #scan-frame {
    position: absolute;
    border: 2.8px solid #0af;
    border-radius: 14px;
    pointer-events: none;
    box-sizing: border-box;
    top: 20%;
    left: 7.5%;
    width: 85%;
    height: 45%;
    transition: all 0.3s ease;
    box-shadow: inset 0 0 9px rgba(10, 170, 255, 0.3);
  }
  .controls {
    width: 100%;
    max-width: 440px;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: space-between;
    align-items: center;
  }
  select, button {
    background: #222;
    border: none;
    color: #eee;
    padding: 0.7rem 1.3rem;
    font-size: 1rem;
    border-radius: 14px;
    cursor: pointer;
    box-shadow: inset 0 0 6px #111;
    transition: background-color 0.3s ease;
    flex: 1 1 48%;
    max-width: 48%;
    user-select: none;
  }
  select:hover, button:hover:not(:disabled) {
    background: #0a1e42;
    box-shadow: inset 0 0 10px #0af;
  }
  button:disabled {
    background: #333;
    cursor: not-allowed;
    box-shadow: none;
    color: #666;
  }
  #flash-btn {
    max-width: 150px;
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: #111;
    user-select: none;
  }
  #flash-btn svg {
    fill: #0af;
    width: 20px;
    height: 20px;
  }
  #status {
    font-size: 0.9rem;
    color: #66aaff;
    min-height: 1.3rem;
    margin-bottom: 0.5rem;
    text-align: center;
    user-select: none;
  }
  #result {
    white-space: pre-wrap;
    background: #1e1e1e;
    border-radius: 16px;
    padding: 1rem 1.2rem;
    max-width: 440px;
    width: 100%;
    color: #ccc;
    font-family: monospace;
    user-select: text;
    box-shadow: inset 0 0 9px #0af4;
    max-height: 220px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #0af #222;
  }
  #result::-webkit-scrollbar {
    width: 6px;
  }
  #result::-webkit-scrollbar-thumb {
    background-color: #0af;
    border-radius: 3px;
  }
  @media (max-width: 400px) {
    select, button {
      flex: 1 1 100%;
      max-width: 100%;
    }
  }
</style>
</head>
<body>

<header>DE Ausweis & Aufenthaltstitel Scanner</header>

<main>
  <div id="video-container" aria-label="Kamera Vorschau">
    <video id="video" autoplay playsinline></video>
    <div id="scan-frame" aria-hidden="true"></div>
  </div>

  <div class="controls" role="region" aria-label="Steuerung">
    <select id="doc-type" aria-label="Dokumenttyp">
      <option value="aufenthaltstitel" selected>Aufenthaltstitel</option>
      <option value="ausweis">Personalausweis</option>
    </select>
    <select id="doc-side" aria-label="Seite wählen">
      <option value="front" selected>Vorderseite</option>
      <option value="back">Rückseite</option>
    </select>
    <button id="flash-btn" aria-pressed="false" title="Blitz an/aus (schwach)">⚡ Blitz</button>
    <button id="scan-btn" aria-label="Scan starten">Scan starten</button>
  </div>

  <div id="status" aria-live="polite" role="status"></div>
  <pre id="result" aria-live="polite" role="region" tabindex="0" aria-label="Erkannte Daten"></pre>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script>
(async () => {
  const video = document.getElementById('video');
  const scanFrame = document.getElementById('scan-frame');
  const docTypeSelect = document.getElementById('doc-type');
  const docSideSelect = document.getElementById('doc-side');
  const scanBtn = document.getElementById('scan-btn');
  const flashBtn = document.getElementById('flash-btn');
  const statusDiv = document.getElementById('status');
  const resultDiv = document.getElementById('result');

  let stream;
  let track;
  let flashOn = false;

  async function startCamera() {
    statusDiv.textContent = 'Kamera wird gestartet...';
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 960 }
        },
        audio: false
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];

      if ('torch' in track.getCapabilities()) {
        flashBtn.disabled = false;
        flashBtn.setAttribute('aria-disabled', 'false');
      } else {
        flashBtn.disabled = true;
        flashBtn.setAttribute('aria-disabled', 'true');
      }
      statusDiv.textContent = 'Kamera bereit. Dokument positionieren.';
    } catch (e) {
      statusDiv.textContent = 'Kamera konnte nicht gestartet werden: ' + e.message;
      flashBtn.disabled = true;
      scanBtn.disabled = true;
    }
  }

  flashBtn.addEventListener('click', async () => {
    if (!track) return;
    try {
      flashOn = !flashOn;
      await track.applyConstraints({
        advanced: [{ torch: flashOn }]
      });
      flashBtn.setAttribute('aria-pressed', flashOn.toString());
      flashBtn.textContent = flashOn ? '⚡ Blitz (an)' : '⚡ Blitz';
    } catch {
      statusDiv.textContent = 'Blitz kann nicht gesteuert werden.';
    }
  });

  function getCropRect() {
    const videoRect = video.getBoundingClientRect();
    const frameRect = scanFrame.getBoundingClientRect();

    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;

    return {
      x: (frameRect.left - videoRect.left) * scaleX,
      y: (frameRect.top - videoRect.top) * scaleY,
      width: frameRect.width * scaleX,
      height: frameRect.height * scaleY
    };
  }

  function updateScanFrame() {
    // Positions und Größen je nach Auswahl anpassen
    const docType = docTypeSelect.value;
    const docSide = docSideSelect.value;

    if (docType === 'aufenthaltstitel') {
      if (docSide === 'front') {
        scanFrame.style.top = '20%';
        scanFrame.style.left = '7.5%';
        scanFrame.style.width = '85%';
        scanFrame.style.height = '45%';
      } else {
        scanFrame.style.top = '35%';
        scanFrame.style.left = '6%';
        scanFrame.style.width = '88%';
        scanFrame.style.height = '45%';
      }
    } else {
      // Personalausweis
      if (docSide === 'front') {
        scanFrame.style.top = '18%';
        scanFrame.style.left = '8%';
        scanFrame.style.width = '84%';
        scanFrame.style.height = '48%';
      } else {
        scanFrame.style.top = '32%';
        scanFrame.style.left = '8%';
        scanFrame.style.width = '84%';
        scanFrame.style.height = '50%';
      }
    }
  }

  docTypeSelect.addEventListener('change', () => {
    updateScanFrame();
    clearResult();
  });
  docSideSelect.addEventListener('change', () => {
    updateScanFrame();
    clearResult();
  });

  function clearResult() {
    statusDiv.textContent = '';
    resultDiv.textContent = '';
  }

  async function scanImage() {
    if (!track) return;
    statusDiv.textContent = 'Scan läuft...';

    // Video-Frame holen und beschneiden auf Scan-Frame Bereich
    const crop = getCropRect();
    const canvas = document.createElement('canvas');
    canvas.width = crop.width;
    canvas.height = crop.height;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, crop.x, crop.y, crop.width, crop.height, 0, 0, canvas.width, canvas.height);

    // Optional: Kontrast erhöhen
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < imgData.data.length; i += 4) {
      // einfache Kontraststeigerung (leicht)
      for (let c = 0; c < 3; c++) {
        let val = imgData.data[i + c];
        val = ((val - 128) * 1.2) + 128;
        imgData.data[i + c] = Math.min(255, Math.max(0, val));
      }
    }
    ctx.putImageData(imgData, 0, 0);

    // OCR starten mit Tesseract
    statusDiv.textContent = 'Texterkennung läuft...';
    try {
      const { data: { text } } = await Tesseract.recognize(canvas, 'deu', {
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789ÄÖÜß .,-/:',
        logger: m => {
          // Optional: Fortschritt anzeigen
          if (m.status === 'recognizing text') {
            statusDiv.textContent = `Texterkennung: ${(m.progress * 100).toFixed(0)}%`;
          }
        }
      });

      statusDiv.textContent = 'Text erkannt, Daten werden ausgewertet...';
      const parsed = parseDocumentText(text, docTypeSelect.value, docSideSelect.value);
      displayResult(parsed, text);
    } catch (err) {
      statusDiv.textContent = 'Fehler bei der Texterkennung: ' + err.message;
    }
  }

  function displayResult(parsed, rawText) {
    let output = '';
    if (Object.keys(parsed).length === 0) {
      output += 'Keine Daten erkannt.\n\n';
    } else {
      output += 'Extrahierte Daten:\n';
      for (const [key, value] of Object.entries(parsed)) {
        output += `${key}: ${value}\n`;
      }
      output += '\n';
    }
    output += 'Roh-Text:\n' + rawText.trim();
    resultDiv.textContent = output;
  }

  function parseDocumentText(text, docType, docSide) {
    // Vereinfachtes Parsing mit Regex für typische deutsche Ausweisdaten und Aufenthaltstitel
    // Je nach Dokumenttyp & Seite variiert die Struktur

    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const parsed = {};

    // Beispiel für Aufenthaltstitel Vorderseite:
    // Name, Geburtsdatum, Gültig bis, DokNr, Staatsangehörigkeit, Adresse

    if (docType === 'aufenthaltstitel') {
      if (docSide === 'front') {
        // Suche nach Name (Zeile mit "Name" oder Zeile mit Großbuchstaben)
        for (let line of lines) {
          if (/Name/i.test(line)) {
            const nm = line.replace(/Name\s*[:\-]?/i, '').trim();
            if (nm) parsed['Name'] = nm;
            break;
          }
        }
        // Geburtsdatum
        for (let line of lines) {
          const dobMatch = line.match(/Geburtsdatum\s*[:\-]?\s*(\d{2}[.\-/]\d{2}[.\-/]\d{4})/i);
          if (dobMatch) {
            parsed['Geburtsdatum'] = dobMatch[1];
            break;
          }
        }
        // Gültig bis
        for (let line of lines) {
          const expMatch = line.match(/Gültig bis\s*[:\-]?\s*(\d{2}[.\-/]\d{2}[.\-/]\d{4})/i);
          if (expMatch) {
            parsed['Gültig bis'] = expMatch[1];
            break;
          }
        }
        // Dokumentnummer
        for (let line of lines) {
          const docNumMatch = line.match(/Dok(ument)?nummer\s*[:\-]?\s*([A-Z0-9]{8,15})/i);
          if (docNumMatch) {
            parsed['Dokumentnummer'] = docNumMatch[2];
            break;
          }
        }
        // Staatsangehörigkeit
        for (let line of lines) {
          if (/Staatsangehörigkeit/i.test(line)) {
            const sn = line.replace(/Staatsangehörigkeit\s*[:\-]?/i, '').trim();
            if (sn) parsed['Staatsangehörigkeit'] = sn;
            break;
          }
        }
      } else {
        // Aufenthaltstitel Rückseite
        // Suche MRZ (Machine Readable Zone) am unteren Rand, typischerweise zwei Zeilen mit Buchstaben und Ziffern
        const mrzLines = lines.filter(l => /^[A-Z0-9<]{10,}$/.test(l));
        if (mrzLines.length >= 2) {
          parsed['MRZ1'] = mrzLines[0];
          parsed['MRZ2'] = mrzLines[1];
        }
      }
    } else if (docType === 'ausweis') {
      if (docSide === 'front') {
        // Personalausweis Frontseite: Name, Vorname, Geburtsdatum, Ausweis-Nr
        for (let line of lines) {
          if (/Nachname/i.test(line) || /Name/i.test(line)) {
            const name = line.replace(/(Nachname|Name)\s*[:\-]?/i, '').trim();
            if (name) parsed['Nachname'] = name;
          }
          if (/Vorname/i.test(line)) {
            const vorname = line.replace(/Vorname\s*[:\-]?/i, '').trim();
            if (vorname) parsed['Vorname'] = vorname;
          }
          if (/Geburtsdatum/i.test(line)) {
            const dobMatch = line.match(/Geburtsdatum\s*[:\-]?\s*(\d{2}[.\-/]\d{2}[.\-/]\d{4})/i);
            if (dobMatch) parsed['Geburtsdatum'] = dobMatch[1];
          }
          if (/Ausweisnummer/i.test(line)) {
            const num = line.replace(/Ausweisnummer\s*[:\-]?/i, '').trim();
            if (num) parsed['Ausweisnummer'] = num;
          }
        }
      } else {
        // Personalausweis Rückseite
        // MRZ wie bei Aufenthaltstitel
        const mrzLines = lines.filter(l => /^[A-Z0-9<]{10,}$/.test(l));
        if (mrzLines.length >= 2) {
          parsed['MRZ1'] = mrzLines[0];
          parsed['MRZ2'] = mrzLines[1];
        }
      }
    }

    return parsed;
  }

  scanBtn.addEventListener('click', scanImage);

  updateScanFrame();
  await startCamera();
})();
</script>

</body>
</html>
